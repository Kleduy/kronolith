var frames={horde_main:true},KronolithCore={view:"",remove_gc:[],date:new Date(),debug:function(A,B){if(!this.is_logout&&Kronolith.conf.debug){alert(A+": "+(B instanceof Error?B.name+"-"+B.message:Object.inspect(B)))}},setTitle:function(A){document.title=Kronolith.conf.name+" :: "+A},showNotifications:function(A){if(!A.size()||this.is_logout){return}A.find(function(B){switch(B.type){case"kronolith.timeout":this.logout(Kronolith.conf.timeout_url);return true;case"horde.error":case"horde.message":case"horde.success":case"horde.warning":case"kronolith.request":case"kronolith.sticky":var E,D,C,G=$("alerts"),H=new Element("DIV",{className:B.type.replace(".","-")}),F=B.message;if(!G){G=new Element("DIV",{id:"alerts"});$(document.body).insert(G)}if($w("kronolith.request kronolith.sticky").indexOf(B.type)==-1){F=F.unescapeHTML().unescapeHTML()}G.insert(H.update(F));if(Kronolith.conf.is_ie6){E=new Element("DIV",{id:"ie6alertsfix"}).clonePosition(H,{setLeft:false,setTop:false});E.insert(H.remove());G.insert(E)}if($w("horde.error kronolith.request kronolith.sticky").indexOf(B.type)==-1){this.alertsFade.bind(this,H).delay(B.type=="horde.warning"?10:3)}if(B.type=="kronolith.request"){this.alertrequest=H}if(C=$("alertslog")){switch(B.type){case"horde.error":D=Kronolith.text.alog_error;break;case"horde.message":D=Kronolith.text.alog_message;break;case"horde.success":D=Kronolith.text.alog_success;break;case"horde.warning":D=Kronolith.text.alog_warning;break}if(D){C=C.down("DIV UL");if(C.down().hasClassName("noalerts")){C.down().remove()}C.insert(new Element("LI").insert(new Element("P",{className:"label"}).insert(D)).insert(new Element("P",{className:"indent"}).insert(F).insert(new Element("SPAN",{className:"alertdate"}).insert("["+(new Date).toLocaleString()+"]"))))}}}},this)},alertsFade:function(A){if(A){Effect.Fade(A,{duration:1.5,afterFinish:this.removeAlert.bind(this)})}},toggleAlertsLog:function(){var A=$("alertsloglink").down("A"),C=$("alertslog").down("DIV"),B={duration:0.5};if(C.visible()){Effect.BlindUp(C,B);A.update(Kronolith.text.showalog)}else{Effect.BlindDown(C,B);A.update(Kronolith.text.hidealog)}},removeAlert:function(C){try{var A=$(C.element),B=A.up();A.remove();if(!B.childElements().size()&&B.readAttribute("id")=="ie6alertsfix"){B.remove()}}catch(D){this.debug("removeAlert",D)}},logout:function(A){this.is_logout=true;this.redirect(A||(Kronolith.conf.URI_IMP+"/LogOut"))},redirect:function(A){A=this.addSID(A);if(parent.frames.horde_main){parent.location=A}else{window.location=A}},addMouseEvents:function(A){this.DMenu.addElement(A.id,"ctx_"+A.type,A)},removeMouseEvents:function(A){this.DMenu.removeElement($(A).identify());this.addGC(A)},addPopdown:function(B,A){var C=$(B);C.insert({after:$($("popdown_img").cloneNode(false)).writeAttribute("id",B+"_img").show()});this.addMouseEvents({id:B+"_img",type:A,offset:C.up(),left:true})},addGC:function(A){this.remove_gc=this.remove_gc.concat(A)},addSID:function(A){if(!Kronolith.conf.SESSION_ID){return A}return this.addURLParam(A,Kronolith.conf.SESSION_ID.toQueryParams())},addURLParam:function(A,C){var B=A.indexOf("?");if(B!=-1){C=$H(A.toQueryParams()).merge(C).toObject();A=A.substring(0,B)}return A+"?"+Object.toQueryString(C)},go:function(A,D){var B=A.split(":");var E=B.shift();switch(E){case"day":case"week":case"month":case"year":case"agenda":case"tasks":if(this.view==E){break}var F=E.capitalize();["Day","Week","Month","Year","Tasks","Agenda"].each(function(G){$("kronolithNav"+G).removeClassName("on")});$("kronolithNav"+F).addClassName("on");if(this.view){$("kronolithView"+this.view.capitalize()).fade()}switch(E){case"day":case"week":case"month":case"year":var C=B.shift();if(C){C=this.parseDate(C)}else{C=this.date}this.updateView(C,E);if($("kronolithView"+F)){$("kronolithView"+F).appear()}this.updateMinical(C,E);$("kronolithBody").select("div.kronolithEvent").each(function(G){G.observe("mouseover",G.addClassName.curry("kronolithSelected"));G.observe("mouseout",G.removeClassName.curry("kronolithSelected"))});this.date=C;break;default:if($("kronolithView"+F)){$("kronolithView"+F).appear()}break}this._addHistory(A);this.view=E;break;case"options":this._addHistory(E);this.setTitle(Kronolith.text.prefs);this.iframeContent(E,Kronolith.conf.prefs_url);break}},updateView:function(F,D){switch(D){case"day":$("kronolithViewDay").down(".kronolithCol").setText(F.toString("D"));break;case"month":var C=$("kronolithViewMonth").down(".kronolithViewBody"),E=F.clone(),G=F.clone(),B,A;E.setDate(1);this.moveToBeginOfWeek(E);G.moveToLastDayOfMonth();this.moveToBeginOfWeek(G);C.childElements().invoke("remove");while(E.compareTo(G)<1){var H=C.insert(this.createWeekRow(E,F.getMonth()).show());E.next().week()}break}},createWeekRow:function(D,E){var B=D.clone(),C=D.clone();if(B.getDay()!=1){B.moveToDayOfWeek(1,1)}var F=$("kronolithRowTemplate").cloneNode(true);F.removeAttribute("id");var A=F.down().setText(B.getWeek()).next();while(A){A.removeClassName("kronolithOtherMonth");if(typeof E!="undefined"&&C.getMonth()!=E){A.addClassName("kronolithOtherMonth")}A.down(".kronolithDay").setText(C.getDate());A=A.next();C.add(1).day()}return F},updateMinical:function(B,H){var D=$("kronolithMinical").down("tbody"),G=B.clone(),E=B.clone(),J,A,I,C,F;G.setDate(1);this.moveToBeginOfWeek(G);E.moveToLastDayOfMonth();this.moveToEndOfWeek(E);$("kronolithMinicalDate").setText(B.toString("MMMM yyyy")).setAttribute("date",B.toString("yyyyMMdd"));D.childElements().invoke("remove");while(G.compareTo(E)<1){if(G.getDay()==Kronolith.conf.week_start){F=new Element("tr");D.insert(F);C=new Element("td",{"class":"kronolithMinicalWeek",date:G.toString("yyyyMMdd")}).setText(G.getWeek());F.insert(C);J=G.clone();A=G.clone();A.add(6).days()}C=new Element("td",{date:G.toString("yyyyMMdd")});if(G.getMonth()!=B.getMonth()){C.addClassName("kronolithMinicalEmpty")}if(H&&(H=="month"||(H=="week"&&B.between(J,A))||(H=="day"&&B.compareTo(G)==0))){C.addClassName("kronolithSelected")}C.setText(G.getDate());F.insert(C);G.next().day()}},parseDate:function(A){return new Date(A.substr(0,4),A.substr(4,2)-1,A.substr(6,2))},moveToEndOfWeek:function(B){var A=Kronolith.conf.week_start+6;if(A>6){A-=7}if(B.getDay()!=A){B.moveToDayOfWeek(A,1)}return B},moveToBeginOfWeek:function(A){if(A.getDay()!=Kronolith.conf.week_start){A.moveToDayOfWeek(Kronolith.conf.week_start,-1)}return A},_addHistory:function(B,A){if(Horde.dhtmlHistory.getCurrentLocation()!=B){Horde.dhtmlHistory.add(B,A)}},iframeContent:function(B,D){if(B===null){B=D}var A=$("dimpmain_portal"),C;if(!A){this.showNotifications([{type:"horde.error",message:"Bad portal!"}]);return}C=new Element("IFRAME",{id:"iframe"+B,className:"iframe",frameBorder:0,src:D});this._resizeIE6Iframe(C);if(B=="options"){C.observe("load",function(){$("iframeoptions").contentWindow.document.getElementById("menu").style.display="none"})}A.insert(C)},_onMenuShow:function(A){var E,C,B,D;switch(A.ctx){case"ctx_folder":E=$("ctx_folder_create","ctx_folder_rename","ctx_folder_delete");C=this.DMenu.element();if(C.readAttribute("mbox")=="INBOX"){E.invoke("hide")}else{if(Kronolith.conf.fixed_folders.indexOf(C.readAttribute("mbox"))!=-1){E.shift();E.invoke("hide")}else{E.invoke("show")}}if(C.hasAttribute("u")){$("ctx_folder_poll").hide();$("ctx_folder_nopoll").show()}else{$("ctx_folder_poll").show();$("ctx_folder_nopoll").hide()}break;case"ctx_message":[$("ctx_message_reply_list")].invoke(this.viewport.createSelection("domid",A.id).get("dataob").first().listmsg?"show":"hide");break;case"ctx_reply":D=this.viewport.getSelected();if(D.size()==1){B=D.get("dataob").first()}[$("ctx_reply_reply_list")].invoke(B&&B.listmsg?"show":"hide");break;case"ctx_otheractions":$("oa_seen","oa_unseen","oa_flagged","oa_clear","oa_sep1","oa_blacklist","oa_whitelist","oa_sep2").compact().invoke(this.viewport.getSelected().size()?"show":"hide");break}return true},_onResize:function(B,A){if(this.viewport){this.viewport.onResize(B,A)}this._resizeIE6()},updateTitle:function(){var B,A,C;if(this.viewport.isFiltering()){A=Kronolith.text.search+" :: "+this.viewport.getMetaData("total_rows")+" "+Kronolith.text.resfound}else{B=$(this.getFolderId(this.folder));if(B){C=B.readAttribute("u");A=B.readAttribute("l");if(C>0){A+=" ("+C+")"}}else{A=this.viewport.getMetaData("label")}}this.setTitle(A)},_keydownHandler:function(B){var A=B.keyCode||B.charCode;switch(A){case Event.KEY_ESC:this._closeRedBox();break}},_keyupHandler:function(A){},_clickHandler:function(E,D){if(E.isRightClick()){return}var B=E.element(),G=E.element(),F,C;if(this.alertrequest){this.alertsFade(this.alertrequest);this.alertrequest=null}while(Object.isElement(B)){F=B.readAttribute("id");switch(F){case"kronolithLogo":this.go("portal");E.stop();return;case"id_fullday":this.eventForm.select(".edit_at").each(Element.toggle);E.stop();return;case"kronolithNewEvent":this.editEvent();E.stop();return;case"kronolithEventActions":if(G.match("input.button")){this._closeRedBox()}E.stop();return;case"kronolithNavDay":case"kronolithNavWeek":case"kronolithNavMonth":this.go(F.substring(12).toLowerCase());E.stop();return;case"kronolithMenu":if(G.match("div.kronolithCalendars div")){this.toggleCalendar(G)}E.stop();return;case"kronolithMinicalDate":this.go("month:"+G.readAttribute("date"));E.stop();return;case"kronolithMinical":if(G.id=="kronolithMinicalPrev"){var A=this.parseDate($("kronolithMinicalDate").readAttribute("date"));A.previous().month();this.updateMinical(A);E.stop();return}if(G.id=="kronolithMinicalNext"){var A=this.parseDate($("kronolithMinicalDate").readAttribute("date"));A.next().month();this.updateMinical(A);E.stop();return}var C=G;if(C.tagName!="td"){C.up("td")}if(C&&C.readAttribute("date")){if(C.hasClassName("kronolithMinicalWeek")){this.go("week:"+C.readAttribute("date"))}else{if(!C.hasClassName("empty")){this.go("day:"+C.readAttribute("date"))}}}E.stop();return;case"kronolithViewMonth":if(G.hasClassName("kronolithFirstCol")){this.go("week")}else{if(G.hasClassName("kronolithDay")){this.go("day")}}E.stop();return;case"kronolithBody":var C=G;if(!C.match("div.kronolithEvent")){C=C.up("div.kronolithEvent")}if(C){this.editEvent()}E.stop();return;case"alertsloglink":this.toggleAlertsLog();break;case"alerts":this.alertsFade(B);break}B=B.up()}},_mouseHandler:function(B,A){},editEvent:function(){$("kronolithEventForm").select("div.kronolithTags span").each(function(A){$("id_tags").value=$F("id_tags")+A.getText()+", "});RedBox.showHtml($("kronolithEventForm").show());this.eventForm=RedBox.getWindowContents()},_closeRedBox:function(){RedBox.close();this.eventForm=null},onLoad:function(){if(Horde.dhtmlHistory.initialize()){Horde.dhtmlHistory.addListener(this.go.bind(this))}if(!Horde.dhtmlHistory.getCurrentLocation()){this.go(Kronolith.conf.login_view)}$("kronolithMenu").select("div.kronolithCalendars div").each(function(A){A.observe("mouseover",A.addClassName.curry("kronolithCalOver"));A.observe("mouseout",A.removeClassName.curry("kronolithCalOver"))});this._resizeIE6()},_resizeIE6:function(){var C=(($("kronolithViewMonth").getWidth()-20-2-2-16)/7)-2-2;$("kronolithViewMonth").select(".kronolithCol").invoke("setStyle",{width:C+"px"});var A=(($("kronolithViewMonth").getHeight()-25)/6)-2-2;$("kronolithViewMonth").select(".kronolithViewBody .kronolithCol").invoke("setStyle",{height:A+"px"});$("kronolithViewMonth").select(".kronolithViewBody .kronolithFirstCol").invoke("setStyle",{height:A+"px"});$("kronolithViewWeek").select(".kronolithCol").invoke("setStyle",{width:(C-1)+"px"});var B=$("kronolithViewDay").getWidth()-20-2-2-16-3;var C=((B+7)/7)-1;$("kronolithViewDay").select(".kronolithViewHead .kronolithCol").invoke("setStyle",{width:B+"px"});$("kronolithViewDay").select(".kronolithViewBody .kronolithCol").invoke("setStyle",{width:C+"px"});$("kronolithViewDay").select(".kronolithViewBody .kronolithAllDay .kronolithCol").invoke("setStyle",{width:B+"px"})},_resizeIE6Iframe:function(A){if(Kronolith.conf.is_ie6){A.setStyle({width:$("kronolithmain").getStyle("width"),height:(document.viewport.getHeight()-20)+"px"})}},toggleCalendar:function(A){if(A.hasClassName("on")){A.removeClassName("on")}else{A.addClassName("on")}}};if(typeof ContextSensitive!="undefined"){KronolithCore.DMenu=new ContextSensitive()}document.observe("dom:loaded",function(){try{if(parent.opener&&parent.opener.location.host==window.location.host&&parent.opener.KronolithCore){Kronolith.baseWindow=parent.opener.Kronolith.baseWindow||parent.opener}}catch(A){}new PeriodicalExecuter(function(){if(KronolithCore.remove_gc.size()){try{$A(KronolithCore.remove_gc.splice(0,75)).compact().invoke("stopObserving")}catch(B){KronolithCore.debug("remove_gc[].stopObserving",B)}}},10);KronolithCore.onLoad();document.observe("keydown",KronolithCore._keydownHandler.bindAsEventListener(KronolithCore));document.observe("keyup",KronolithCore._keyupHandler.bindAsEventListener(KronolithCore));document.observe("click",KronolithCore._clickHandler.bindAsEventListener(KronolithCore));document.observe("dblclick",KronolithCore._clickHandler.bindAsEventListener(KronolithCore,true));document.observe("mouseover",KronolithCore._mouseHandler.bindAsEventListener(KronolithCore,"over"));Event.observe(window,"resize",KronolithCore._onResize.bind(KronolithCore));if(Kronolith.conf.is_ie6){document.observe("selectstart",Event.stop);$("foobar").compact().invoke("select","LI").flatten().compact().each(function(B){B.observe("mouseover",B.addClassName.curry("over")).observe("mouseout",B.removeClassName.curry("over"))})}});Event.observe(window,"load",function(){KronolithCore.window_load=true});Element.addMethods({setText:function(B,C){var A=0;$A(B.childNodes).each(function(D){if(D.nodeType==3){if(A++){Element.remove(D)}else{D.nodeValue=C}}});if(!A){$(B).insert(C)}return B},getText:function(B,A){var C="";$A(B.childNodes).each(function(D){if(D.nodeType==3){C+=D.nodeValue}else{if(A&&D.hasChildNodes()){C+=$(D).getText(true)}}});return C}});Object.extend(Array.prototype,{numericSort:function(){return this.sort(function(B,A){if(B>A){return 1}else{if(B<A){return-1}}return 0})}});Object.extend(String.prototype,{evalScripts:function(){var re=/function\s+([^\s(]+)/g;this.extractScripts().each(function(s){var func;eval(s);while(func=re.exec(s)){window[func[1]]=eval(func[1])}})}});